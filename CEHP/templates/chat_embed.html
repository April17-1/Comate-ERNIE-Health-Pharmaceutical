<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æ–‡å¿ƒå¥åº·åŠ©æ‰‹</title>

  <style>
    :root {
      --font-scale: 1;
      --bg-grad-1: #eef2ff;
      --bg-grad-2: #e0f2fe;
      --card-bg: rgba(255,255,255,0.92);
      --ai-bg: #eef2ff;
      --user-bg: #2563eb;
      --ai-text: #111827;
      --user-text: #ffffff;
      --subtext: #6b7280;
      --shadow-soft: 0 18px 40px rgba(15,23,42,0.12);
      --radius-lg: 20px;
      --radius-sm: 14px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 24px 12px;
      background: radial-gradient(circle at top left, var(--bg-grad-1), var(--bg-grad-2));
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      font-size: calc(14px * var(--font-scale));
      color: #111827;
    }

    /* æ•´ä½“å®¹å™¨ */
    #app {
      width: 100%;
      max-width: 1100px;
      background: var(--card-bg);
      backdrop-filter: blur(18px);
      border-radius: 26px;
      box-shadow: var(--shadow-soft);
      padding: 18px 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* é¡¶éƒ¨æ ï¼šæ ‡é¢˜ + æ¨¡å¼æŒ‰é’® */
    #topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 4px 4px 0;
    }

    #headerInfo {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #headerTitle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: calc(22px * var(--font-scale));
      font-weight: 700;
    }

    #headerTitle span.icon {
      font-size: calc(24px * var(--font-scale));
    }

    #headerSubtitle {
      font-size: calc(13px * var(--font-scale));
      color: var(--subtext);
    }

    #modeButtons {
      display: flex;
      gap: 8px;
    }

    .mode-btn {
      padding: 6px 16px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      cursor: pointer;
      font-size: calc(12px * var(--font-scale));
      color: #374151;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.18s ease-out;
    }
    .mode-btn.active {
      background: #2563eb;
      border-color: #2563eb;
      color: #ffffff;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.16);
    }

    /* èŠå¤©æ°”æ³¡åŒºåŸŸ */
    #chatShell {
      margin-top: 4px;
      background: rgba(248,250,252,0.95);
      border-radius: var(--radius-lg);
      padding: 14px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #chatbox {
      max-height: 60vh;
      min-height: 52vh;
      overflow-y: auto;
      padding: 6px 6px 2px;
    }

    .time-label {
      text-align: center;
      font-size: calc(11px * var(--font-scale));
      color: #9ca3af;
      margin: 8px 0 4px;
    }

    .message-row {
      display: flex;
      margin: 4px 0;
    }
    .message-row.ai {
      justify-content: flex-start;
    }
    .message-row.user {
      justify-content: flex-end;
    }

    .message-inner {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      max-width: 78%;
    }

    .message-row.user .message-inner {
      flex-direction: row-reverse;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
      box-shadow: 0 4px 8px rgba(15,23,42,0.16);
      background: #2563eb;
      color: white;
    }
    .avatar.ai {
      background: linear-gradient(135deg,#22c55e,#16a3b8);
    }

    .bubble {
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      white-space: pre-wrap;
      word-break: break-word;
      font-size: calc(14px * var(--font-scale));
      line-height: 1.65;
      box-shadow: 0 2px 6px rgba(15,23,42,0.06);
    }

    .bubble.ai {
      background: var(--ai-bg);
      color: var(--ai-text);
      border-bottom-left-radius: 4px;
    }
    .bubble.user {
      background: var(--user-bg);
      color: var(--user-text);
      border-bottom-right-radius: 4px;
    }

    /* Markdown åœ¨æ°”æ³¡å†…éƒ¨çš„æ ·å¼å¾®è°ƒ */
    .bubble.ai h1,
    .bubble.ai h2,
    .bubble.ai h3 {
      margin: 0.35em 0 0.2em;
      font-weight: 600;
    }
    .bubble.ai p {
      margin: 0.25em 0;
    }
    .bubble.ai ul,
    .bubble.ai ol {
      margin: 0.2em 0 0.2em 1.2em;
      padding-left: 0.2em;
    }
    .bubble.ai strong {
      font-weight: 600;
    }

    /* è¿›åº¦æ¡åŒºåŸŸ */
    #thinkingContainer {
      font-size: calc(12px * var(--font-scale));
      color: var(--subtext);
      display: none;
      padding: 0 6px 2px;
    }
    #thinkingBarOuter {
      height: 4px;
      background:#e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 4px;
    }
    #thinkingBarInner {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg,#2563eb,#38bdf8);
      transition: width 0.12s linear;
    }

    /* è¾“å…¥åŒºåŸŸ */
    #inputAreaWrapper {
      margin-top: 4px;
      padding: 8px 4px 0;
      border-top: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #msg {
      flex: 1;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: calc(14px * var(--font-scale));
      outline: none;
      transition: border-color 0.16s, box-shadow 0.16s;
      background: #ffffff;
    }
    #msg:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.18);
    }

    #send {
      padding: 0 22px;
      height: 40px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      cursor: pointer;
      font-size: calc(14px * var(--font-scale));
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 8px 18px rgba(37,99,235,0.45);
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out, background 0.12s;
    }
    #send:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(37,99,235,0.55);
      background: #1d4ed8;
    }
    #send:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* å°å±è‡ªé€‚åº” */
    @media (max-width: 720px) {
      #app {
        border-radius: 18px;
        padding: 14px 10px 12px;
      }
      .message-inner {
        max-width: 90%;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<div id="app">
  <!-- é¡¶éƒ¨åŒºåŸŸ -->
  <div id="topbar">
    <div id="headerInfo">
      <div id="headerTitle">
        <span class="icon">ğŸ’Š</span>
        <span>æ–‡å¿ƒå¥åº·åŠ©æ‰‹</span>
      </div>
      <div id="headerSubtitle">æƒ³äº†è§£è¯å“è¯´æ˜ã€ç–¾ç—…ä¿¡æ¯ã€è¿˜æ˜¯ç”¨è¯æ³¨æ„äº‹é¡¹ï¼Ÿ</div>
    </div>

    <div id="modeButtons">
      <button class="mode-btn active" id="btnNormal">é»˜è®¤</button>
      <button class="mode-btn" id="btnCare">å…³çˆ±æ¨¡å¼</button>
    </div>
  </div>

  <!-- å¯¹è¯ + è¿›åº¦æ¡ + è¾“å…¥åŒº -->
  <div id="chatShell">
    <div id="chatbox"></div>

    <div id="thinkingContainer">
      æ­£åœ¨æ€è€ƒä¸­â€¦
      <div id="thinkingBarOuter">
        <div id="thinkingBarInner"></div>
      </div>
    </div>

    <div id="inputAreaWrapper">
      <input id="msg" type="text" placeholder="è¯·è¾“å…¥å†…å®¹ï¼Œå›è½¦å‘é€â€¦" />
      <button id="send">å‘é€</button>
    </div>
  </div>
</div>

<script>
  const chatbox = document.getElementById("chatbox");
  const input = document.getElementById("msg");
  const sendBtn = document.getElementById("send");

  const thinkingContainer = document.getElementById("thinkingContainer");
  const thinkingBarInner = document.getElementById("thinkingBarInner");
  let thinkingTimer = null;

  const btnNormal = document.getElementById("btnNormal");
  const btnCare = document.getElementById("btnCare");

  /* æ¨¡å¼åˆ‡æ¢ï¼šè°ƒèŠ‚å…¨å±€å­—ä½“ç¼©æ”¾ */
  btnNormal.onclick = () => {
    document.documentElement.style.setProperty("--font-scale", 1);
    btnNormal.classList.add("active");
    btnCare.classList.remove("active");
  };

  btnCare.onclick = () => {
    document.documentElement.style.setProperty("--font-scale", 1.9);
    btnCare.classList.add("active");
    btnNormal.classList.remove("active");
  };

  function pad(n) {
    return n < 10 ? "0" + n : n;
  }

  function getTimeString() {
    const d = new Date();
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function addMessage(text, sender) {
    const time = document.createElement("div");
    time.className = "time-label";
    time.innerText = getTimeString();
    chatbox.appendChild(time);

    const row = document.createElement("div");
    row.className = "message-row " + sender;

    const inner = document.createElement("div");
    inner.className = "message-inner";

    const avatar = document.createElement("div");
    avatar.className = "avatar " + (sender === "ai" ? "ai" : "user");
    avatar.innerText = sender === "ai" ? "åŒ»" : "æˆ‘";

    const bubble = document.createElement("div");
    bubble.className = "bubble " + sender;

    if (sender === "ai") {
      bubble.innerHTML = marked.parse(text || "");
    } else {
      bubble.innerText = text || "";
    }

    inner.appendChild(avatar);
    inner.appendChild(bubble);
    row.appendChild(inner);
    chatbox.appendChild(row);

    chatbox.scrollTop = chatbox.scrollHeight;
  }

  function startThinking() {
    thinkingContainer.style.display = "block";
    thinkingBarInner.style.width = "0%";
    let p = 0;
    thinkingTimer = setInterval(() => {
      if (p < 90) {
        p += 0.8;
        thinkingBarInner.style.width = p + "%";
      }
    }, 80);
  }

  function stopThinking() {
    if (thinkingTimer) {
      clearInterval(thinkingTimer);
      thinkingTimer = null;
    }
    thinkingBarInner.style.width = "100%";
    setTimeout(() => {
      thinkingContainer.style.display = "none";
      thinkingBarInner.style.width = "0%";
    }, 400);
  }

  async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    addMessage(text, "user");
    input.value = "";
    input.focus();
    sendBtn.disabled = true;
    startThinking();

    try {
      const resp = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      });
      const data = await resp.json();
      addMessage(data.reply, "ai");
    } catch (err) {
      addMessage("åç«¯å‡ºé”™ï¼š" + err, "ai");
    } finally {
      stopThinking();
      sendBtn.disabled = false;
    }
  }

  sendBtn.addEventListener("click", sendMessage);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  /* ========= æ–°å¢ï¼šæ¥æ”¶çˆ¶é¡µé¢â€œè¯ç‰©å’¨è¯¢â€æ¶ˆæ¯ï¼Œå¹¶è‡ªåŠ¨å‘é€ ========= */
  window.addEventListener("message", function (event) {
    const data = event.data || {};
    if (data.type !== "drug_consult") return;

    const text = (data.text || "").trim();
    if (!text) return;

    // æŠŠå†…å®¹å†™å…¥è¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å®Œæ•´ JSON
    input.value = text;

    // å¤ç”¨ç°æœ‰å‘é€é€»è¾‘ï¼ˆä¼šè‡ªåŠ¨è¿½åŠ ç”¨æˆ·æ°”æ³¡ + è°ƒç”¨ /chatï¼‰
    sendMessage();
  });
</script>
</body>
</html>
