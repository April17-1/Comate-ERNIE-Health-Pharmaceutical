<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>æ–‡å¿ƒå¥åº·åŒ»è¯ Fuzzy Matching ç³»ç»Ÿ</title>

  <!-- layui.css -->
  <link href="//unpkg.com/layui@2.9.7/dist/css/layui.css" rel="stylesheet">

  <style>
    /* ========== å…¨å±€åŸºç¡€ ========== */
    body {
      background: #f5f7fb;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue",
                   Arial, "PingFang SC", "Microsoft Yahei", sans-serif;
      margin: 0;
    }

    /* ========== é¡¶éƒ¨å¯¼èˆª ========== */
    .app-header {
      background: #1e9fff;
      color: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
    }
    .app-header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .app-title {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .app-title-sub {
      font-size: 12px;
      opacity: .85;
    }
    .header-right {
      font-size: 12px;
    }
    .header-right a {
      color: #fff;
      text-decoration: underline;
    }

    /* ========== é¡µé¢ä¸»åŒºåŸŸ & å¡ç‰‡ ========== */
    .app-main {
      max-width: 1200px;
      margin: 24px auto 40px;
      padding: 0 16px;
      box-sizing: border-box;
    }
    .card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 12px 30px rgba(15, 35, 95, 0.06);
      padding: 20px 24px;
      box-sizing: border-box;
    }
    .card + .card {
      margin-top: 18px;
    }

    /* ========== è¯´æ˜å¡ç‰‡ & æ–‡å¿ƒåŠ©æ‰‹å…¥å£ ========== */
    .intro-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .intro-text ul {
      margin: 0;
      padding-left: 18px;
      color: #555;
      line-height: 1.7;
      font-size: 14px;
    }

    /* æ–‡å¿ƒå¥åº·åŠ©æ‰‹ï¼šå°å¡ç‰‡æ ·å¼ */
    .assistant-panel {
      display: inline-flex;
      flex-direction: column;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 12px;
      background: linear-gradient(135deg, #4facfe 0%, #00c7ff 45%, #38f9d7 100%);
      color: #fff;
      text-decoration: none;
      box-shadow: 0 8px 22px rgba(0, 175, 255, 0.35);
      transition: all .2s ease;
      min-width: 210px;
      cursor: pointer;
    }
    .assistant-main {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .assistant-sub {
      font-size: 12px;
      opacity: .9;
    }
    .assistant-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      margin-left: auto;
    }
    .assistant-panel:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 26px rgba(0, 175, 255, 0.48);
    }

    /* ========== æœç´¢å¡ç‰‡ ========== */
    .search-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .search-title {
      font-size: 18px;
      font-weight: 600;
      color: #222;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .search-subtitle {
      font-size: 12px;
      color: #999;
    }
    .search-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 4px;
    }
    .search-icon {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: #f0f6ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1e9fff;
      flex-shrink: 0;
    }
    .search-input-wrap {
      flex: 1;
      position: relative;
    }
    .search-input {
      width: 100%;
      height: 48px;
      border-radius: 12px;
      border: 1px solid #e3e7f0;
      padding: 0 14px;
      font-size: 15px;
      box-sizing: border-box;
      transition: all .15s ease;
      background: #fff;
    }
    .search-input:focus {
      border-color: #1e9fff;
      box-shadow: 0 0 0 2px rgba(30,159,255,.15);
      outline: none;
    }
    .search-btn {
      height: 48px;
      padding: 0 28px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
    }

    /* ========== ç»“æœå¡ç‰‡ & è¡¨æ ¼ ========== */
    .result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .result-title {
      font-size: 16px;
      font-weight: 600;
      color: #222;
    }
    .result-meta {
      font-size: 12px;
      color: #999;
    }
    #drug-table {
      margin-top: 6px;
    }

    /* è¯å“åç§°é“¾æ¥æ ·å¼ */
    .drug-link {
      color: #1e88e5;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
    }
    .drug-link:hover {
      color: #0d47a1;
      text-decoration: underline;
    }

    /* è¯å“è¯¦æƒ…å¼¹çª—æ•´ä½“å®¹å™¨ */
    .drug-detail-box {
      padding: 18px 22px;
      background: #f9fafb;
      height: 100%;
      box-sizing: border-box;
      overflow-y: auto;
      font-size: 14px;
      color: #111827;
    }

    .drug-detail-header {
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .drug-consult-btn {
      border: none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #fff;
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(34,197,94,0.35);
      white-space: nowrap;
    }
    .drug-consult-btn:hover {
      background: linear-gradient(135deg, #16a34a, #15803d);
    }

    .drug-detail-title {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }
    .drug-detail-subtitle {
      font-size: 12px;
      color: #6b7280;
    }

    .drug-detail-grid {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .drug-detail-row {
      display: flex;
      padding: 6px 0;
      border-bottom: 1px dashed #e5e7eb;
    }
    .drug-detail-label {
      width: 96px;
      flex-shrink: 0;
      font-weight: 600;
      color: #374151;
    }
    .drug-detail-value {
      flex: 1;
      color: #111827;
      white-space: pre-wrap;
      line-height: 1.6;
    }

    /* åŸå§‹ JSON åŒºåŸŸ */
    .drug-detail-raw {
      margin-top: 16px;
      padding: 10px 12px 12px;
      background: #111827;
      color: #e5e7eb;
      border-radius: 8px;
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }
    .drug-detail-raw-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 12px;
      color: #9ca3af;
    }
    .drug-json-copy-btn {
      border: none;
      background: rgba(55,65,81,0.7);
      color: #e5e7eb;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      cursor: pointer;
    }
    .drug-json-copy-btn:hover {
      background: rgba(107,114,128,0.9);
    }
    .drug-detail-raw pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-all;
    }

    /* ========== æ–‡å¿ƒåŠ©æ‰‹å¼¹çª— ========== */
    .assistant-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .assistant-modal {
      width: 900px;
      max-width: 95vw;
      height: 600px;
      max-height: 90vh;
      background: #ffffff;
      border-radius: 22px;
      box-shadow: 0 22px 50px rgba(15, 23, 42, 0.35);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: width 0.18s ease, height 0.18s ease, border-radius 0.18s ease;
    }
    .assistant-modal-large {
      width: 1100px;
      height: 720px;
      max-width: 98vw;
      max-height: 92vh;
    }
    .assistant-modal-full {
      width: 100vw;
      height: 100vh;
      max-width: 100vw;
      max-height: 100vh;
      border-radius: 0;
    }
    .assistant-modal-header {
      height: 54px;
      padding: 0 12px 0 18px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(90deg, #eff6ff, #ecfeff);
    }
    .assistant-modal-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .assistant-header-actions {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .assistant-modal-btn {
      border: none;
      background: transparent;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      color: #6b7280;
      padding: 4px 6px;
      border-radius: 999px;
      transition: background 0.12s, color 0.12s, transform 0.08s;
    }
    .assistant-modal-btn:hover {
      background: rgba(15, 23, 42, 0.06);
      color: #111827;
      transform: translateY(-1px);
    }
    .assistant-modal-body {
      flex: 1;
      background: #f3f4f6;
    }
    .assistant-modal-body iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }

    @media (max-width: 768px) {
      .app-header-inner {
        padding-inline: 12px;
      }
      .card {
        padding-inline: 16px;
      }
      .search-bar {
        flex-direction: column;
        align-items: stretch;
      }
      .search-btn {
        width: 100%;
      }
      .intro-content {
        flex-direction: column;
        align-items: flex-start;
      }
      .assistant-modal,
      .assistant-modal-large,
      .assistant-modal-full {
        width: 100vw;
        max-width: 100vw;
        height: 80vh;
        max-height: 80vh;
        border-radius: 18px 18px 0 0;
        margin: 0;
        align-self: flex-end;
      }
    }
  </style>
</head>

<body>

  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="app-header">
    <div class="app-header-inner">
      <div class="app-title">
        <span class="layui-icon layui-icon-component" style="font-size: 24px;"></span>
        <div>
          <div>æ–‡å¿ƒå¥åº·åŒ»è¯ Fuzzy Matching ç³»ç»Ÿ</div>
          <div class="app-title-sub">é¢å‘åŒ»è¯åœºæ™¯çš„æ™ºèƒ½ç›¸ä¼¼æ£€ç´¢ä¸ç”¨è¯å‚è€ƒ</div>
        </div>
      </div>
      <div class="header-right">
        å¼€å‘è€…ï¼š
        <a href="https://april17-1.github.io/" target="_blank">Apirl</a>
      </div>
    </div>
  </header>

  <main class="app-main">

    <!-- è¯´æ˜å¡ç‰‡ -->
    <section class="card intro-card">
      <div class="intro-content">
        <div class="intro-text">
          <ul>
            <li>æ”¯æŒé€šè¿‡è¯å“åç§°æ¨¡ç³ŠåŒ¹é…ï¼Œå¿«é€Ÿå®šä½ç›¸å…³å¤„æ–¹ä¿¡æ¯ã€‚</li>
            <li>é€‚ç”¨äºç”¨è¯å‚è€ƒä¸çŸ¥è¯†æ£€ç´¢åœºæ™¯ï¼Œç»“æœä»…ä¾›ä¸“ä¸šäººå‘˜åˆ¤è¯»ã€‚</li>
          </ul>
        </div>

        <a href="javascript:void(0);" id="assistant-open-btn" class="assistant-panel">
          <div class="assistant-main">
            <i class="layui-icon layui-icon-username" style="font-size: 18px;"></i>
            <span>æ–‡å¿ƒå¥åº·åŠ©æ‰‹</span>
            <span class="assistant-tag">æ™ºèƒ½å’¨è¯¢</span>
          </div>
          <div class="assistant-sub">
            7Ã—24 å°æ—¶å¥åº·é—®ç­” Â· ç—‡çŠ¶è‡ªæŸ¥ä¸ç”¨è¯å»ºè®®
          </div>
        </a>
      </div>
    </section>

    <!-- æœç´¢å¡ç‰‡ -->
    <section class="card">
      <div class="search-card-header">
        <div>
          <div class="search-title">
            <span class="layui-icon layui-icon-search"></span>
            è¯å“æ™ºèƒ½æœç´¢
          </div>
          <div class="search-subtitle">è¾“å…¥è¯å“åç§°æˆ–å…³é”®å­—ï¼Œä¾‹å¦‚ï¼šâ€œæ„Ÿå†’çµâ€â€œå¸ƒæ´›èŠ¬â€ç­‰</div>
        </div>
      </div>

      <form id="search-form" action="/search" method="get">
        <div class="search-bar">
          <div class="search-icon">
            <i class="layui-icon layui-icon-form" style="font-size: 24px;"></i>
          </div>

          <div class="search-input-wrap">
            <input
              id="search-input"
              name="query"
              type="text"
              maxlength="100"
              placeholder="è¾“å…¥éœ€è¦æŸ¥è¯¢çš„è¯å“åç§°"
              class="search-input"
            >
          </div>

          <button class="layui-btn layui-btn-normal search-btn" type="submit">
            æœç´¢
          </button>
        </div>
      </form>
    </section>

    <!-- ç»“æœå¡ç‰‡ -->
    <section class="card">
      <div class="result-header">
        <div class="result-title">æœç´¢ç»“æœ</div>
        <div class="result-meta" id="result-meta">æ”¯æŒæ’åºä¸åˆ†é¡µæµè§ˆ</div>
      </div>

      <table class="layui-hide" id="drug-table" lay-filter="drugTableFilter"></table>
    </section>

  </main>

  <!-- æ–‡å¿ƒå¥åº·åŠ©æ‰‹å¼¹çª— -->
  <div id="assistant-modal-overlay" class="assistant-modal-overlay" style="display: none;">
    <div class="assistant-modal" id="assistant-modal" data-size="normal">
      <div class="assistant-modal-header">
        <div class="assistant-modal-title">
          <span>ğŸ’Š</span>
          <span>æ–‡å¿ƒå¥åº·åŠ©æ‰‹</span>
        </div>
        <div class="assistant-header-actions">
          <button class="assistant-modal-btn" id="assistant-modal-resize" title="è°ƒæ•´çª—å£å¤§å°">â¬œ</button>
          <button class="assistant-modal-btn" id="assistant-modal-close" aria-label="å…³é—­">Ã—</button>
        </div>
      </div>
      <div class="assistant-modal-body">
        <iframe src="/chat_embed" frameborder="0" referrerpolicy="no-referrer"></iframe>
      </div>
    </div>
  </div>

  <!-- è¾“å…¥é•¿åº¦æ ¡éªŒ -->
  <script>
    document.getElementById("search-form").addEventListener("submit", function(event) {
      var input = document.getElementById("search-input");
      if (input.value.length > 100) {
        alert("è¾“å…¥çš„å­—ç¬¦æ•°è¶…è¿‡é™åˆ¶ï¼Œè¯·é‡æ–°è¾“å…¥ï¼");
        event.preventDefault();
      }
    });
  </script>

  <!-- layui.js -->
  <script src="//unpkg.com/layui@2.9.8/dist/layui.js"></script>
  <script>
    layui.use(['table', 'layer'], function(){
      var table = layui.table;
      var layer = layui.layer;
  
      // ========= 1. å…ˆå–é™æ€ JSONï¼Œå†ç”¨ data åšå‰ç«¯åˆ†é¡µ =========
      fetch('/static/json/2/table/demo3.json')
        .then(function (res) { return res.json(); })
        .then(function (res) {
          var rows = (res.rows && res.rows.item) || [];
  
          table.render({
            elem: '#drug-table',
            data: rows,          // ç”¨ dataï¼Œè€Œä¸æ˜¯ url
            page: {
              limit: 10,
              limits: [10, 20, 50]
            },
            cols: [[
              {field:'å¤„æ–¹ç±»å‹', title:'å¤„æ–¹ç±»å‹', width:130, fixed:'left', unresize:true, sort:true},
              {
                field:'è¯å“åç§°',
                title:'è¯å“åç§°',
                width:180,
                templet: function(d){
                  var name = (d['è¯å“åç§°'] || '').replace(/"/g,'&quot;');
                  return '<a href="javascript:;" class="drug-link" data-name="' + name + '">' + name + '</a>';
                }
              },
              {field:'å‚¨è—æ–¹æ³•', title:'å‚¨è—æ–¹æ³•', width:150},
              {field:'ç”¨æ³•ç”¨é‡', title:'ç”¨æ³•ç”¨é‡', width:300, sort:true},
              {field:'é€‚åº”ç—‡',   title:'é€‚åº”ç—‡',   width:450, sort:true},
              {field:'å‰¯ä½œç”¨',   title:'å‰¯ä½œç”¨'},
              {field:'ç¦å¿Œ',     title:'ç¦å¿Œ',     width:150},
              {field:'detail_json', title:'detail_json', hide:true}
            ]],
            height: 420,
            done: function(resData, curr, count){
              var meta = document.getElementById('result-meta');
              if (meta && typeof count === 'number') {
                meta.innerText = 'å…± ' + count + ' æ¡è®°å½•ï¼Œå½“å‰ç¬¬ ' + curr + ' é¡µ';
              }
            }
          });
        });
  
      // ========= é€šç”¨è½¬ä¹‰ =========
      function escapeHtml(str) {
        if (str == null) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }
  
      // ========= æ„é€ è¯å“è¯¦æƒ…å¼¹æ¡† HTML =========
      // æ„é€ å¼¹çª—å†…å®¹ï¼ˆä¸Šé¢å­—æ®µ + ä¸‹é¢é»‘æ¡† JSONï¼Œå…¨é‡å±•ç¤ºå­—æ®µï¼‰
      function buildDrugDetailHtml(data) {
        data = data || {};
        var name     = data['è¯å“åç§°'] || 'æœªå‘½åè¯å“';
        var approval = data['æ‰¹å‡†æ–‡å·'] || data['æ‰¹å·'] || 'â€”â€”';

        // å…ˆæ„é€ ä¸€ä¸ªâ€œå¹²å‡€çš„å¯¹è±¡â€ï¼šå»æ‰ detail_json æœ¬èº«
        var rawObj = Object.assign({}, data);
        delete rawObj['detail_json'];

        var html = '';
        html += '<div class="drug-detail-box">';

        // é¡¶éƒ¨ï¼šå·¦è¾¹æ ‡é¢˜ + å‰¯æ ‡é¢˜ï¼Œå³è¾¹æ–‡å¿ƒå’¨è¯¢æŒ‰é’®
        html += '  <div class="drug-detail-header">';
        html += '    <div>';
        html += '      <div class="drug-detail-title">' + escapeHtml(name) + '</div>';
        html += '      <div class="drug-detail-subtitle">æ‰¹å‡†æ–‡å·ï¼š' + escapeHtml(approval) + '</div>';
        html += '    </div>';
        html += '    <button type="button" class="drug-consult-btn">æ–‡å¿ƒå¥åº· Â· è¯ç‰©å’¨è¯¢</button>';
        html += '  </div>';

        // ====== ä¸ŠåŠéƒ¨åˆ†ï¼šå­—æ®µç½‘æ ¼ï¼Œå°½é‡å±•ç¤ºâ€œæ‰€æœ‰å­—æ®µâ€ ======
        html += '  <div class="drug-detail-grid">';

        function addRow(label, value) {
          if (value == null || value === '') return;
          html += '    <div class="drug-detail-row">';
          html += '      <div class="drug-detail-label">' + escapeHtml(label) + 'ï¼š</div>';
          html += '      <div class="drug-detail-value">' + escapeHtml(value) + '</div>';
          html += '    </div>';
        }

        var used = {};

        // 1ï¼‰ä¼˜å…ˆæŒ‰ä½ å…³å¿ƒçš„å­—æ®µé¡ºåºå±•ç¤ºï¼ˆå¯ä»¥è‡ªè¡Œå¢å‡é¡ºåºï¼‰
        var priorityKeys = [
          'è¯å“åç§°',
          'ç”Ÿäº§ä¼ä¸š',
          'ç”¨æ³•ç”¨é‡',
          'é€‚åº”ç—‡',
          'ç¦å¿Œ',
          'å‰¯ä½œç”¨',
          'è¯å“ç±»å‹',
          'åŒ»ä¿ç±»å‹',
          'å¤„æ–¹ç±»å‹',
          'å‰‚å‹',
          'è§„æ ¼',
          'æˆåˆ†',
          'æ€§çŠ¶',
          'è¯ç†ä½œç”¨',
          'æ³¨æ„äº‹é¡¹',
          'å‚è€ƒä»·æ ¼',
          'å‚¨è—æ–¹æ³•'
        ];

        priorityKeys.forEach(function (key) {
          if (rawObj.hasOwnProperty(key)) {
            addRow(key, rawObj[key]);
            used[key] = true;
          }
        });

        // 2ï¼‰å…¶ä½™æ‰€æœ‰å­—æ®µè‡ªåŠ¨è¡¥ä¸Šï¼ˆä¿è¯â€œä¿¡æ¯ä¸ä¸¢â€ï¼‰
        Object.keys(rawObj).forEach(function (key) {
          if (used[key]) return;           // å·²ç»å±•ç¤ºè¿‡çš„è·³è¿‡
          if (key === 'æ‰¹å‡†æ–‡å·') return;  // å·²ç»åœ¨é¡¶éƒ¨å‰¯æ ‡é¢˜é‡Œæ˜¾ç¤º
          addRow(key, rawObj[key]);
        });

        html += '  </div>'; // end .drug-detail-grid

        // ====== ä¸‹åŠéƒ¨åˆ†ï¼šåŸå§‹ JSON + å¤åˆ¶æŒ‰é’® ======
        var prettyJson = JSON.stringify(rawObj, null, 2);

        // ä¿å­˜ç»™â€œæ–‡å¿ƒå¥åº· Â· è¯ç‰©å’¨è¯¢â€ç”¨
        window.__lastDrugJsonForConsult__  = prettyJson;
        window.__lastDrugNameForConsult__ = name;

        html += '  <div class="drug-detail-raw">';
        html += '    <div class="drug-detail-raw-header">';
        html += '      <span>åŸå§‹ JSON ä¿¡æ¯</span>';
        html += '      <button type="button" class="drug-json-copy-btn">ğŸ“‹ å¤åˆ¶</button>';
        html += '    </div>';
        html += '    <pre id="drug-json-raw-text">' + escapeHtml(prettyJson) + '</pre>';
        html += '  </div>';

        html += '</div>';
        return html;
      }

      // ========= å…¨å±€ç‚¹å‡»äº‹ä»¶ï¼šè¯å“å / å¤åˆ¶ / æ–‡å¿ƒå’¨è¯¢ =========
      document.addEventListener('click', function (e) {
        var target = e.target;
  
        // 1) ç‚¹è¯å“åç§°ï¼šæ‹‰å–è¯¦æƒ…å¹¶å¼¹çª—
        if (target.classList.contains('drug-link')) {
          var drugName = target.getAttribute('data-name') || '';
  
          fetch('/drug_detail?name=' + encodeURIComponent(drugName))
            .then(function (res) { return res.json(); })
            .then(function (res) {
              if (!res || res.status !== 200) {
                layer.msg('è·å–è¯å“è¯¦æƒ…å¤±è´¥', {icon: 2, time: 1500});
                return;
              }
              var data = res.data || {};
              var html = buildDrugDetailHtml(data);
  
              var index = layer.open({
                type: 1,
                title: 'è¯å“è¯¦ç»†ä¿¡æ¯ - ' + (data['è¯å“åç§°'] || drugName),
                area: ['900px', '620px'],
                shadeClose: true,
                maxmin: true,
                content: html
              });

              // è®°å½•å½“å‰è¯å“è¯¦æƒ…å¼¹æ¡†çš„ indexï¼Œä¾›â€œæ–‡å¿ƒå¥åº· Â· è¯ç‰©å’¨è¯¢â€æ—¶å…³é—­
              window.__drugDetailLayerIndex__ = index;

            })
            .catch(function (err) {
              console.error(err);
              layer.msg('æ¥å£å¼‚å¸¸ï¼š' + err, {icon: 2, time: 2000});
            });
  
          return;
        }
  
        // 2) é»‘æ¡† JSON å¤åˆ¶
        if (target.classList.contains('drug-json-copy-btn')) {
          var pre = document.getElementById('drug-json-raw-text');
          if (!pre) return;
          var text = pre.innerText || pre.textContent || '';
  
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function () {
              layer.msg('JSON å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', {icon: 1, time: 1200});
            }).catch(function () {
              layer.msg('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶', {icon: 2, time: 1500});
            });
          } else {
            var temp = document.createElement('textarea');
            temp.value = text;
            document.body.appendChild(temp);
            temp.select();
            try { document.execCommand('copy'); } catch (err) {}
            document.body.removeChild(temp);
            layer.msg('JSON å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', {icon: 1, time: 1200});
          }
          return;
        }
  
        // 3) æ–‡å¿ƒå¥åº· Â· è¯ç‰©å’¨è¯¢
        // 3) æ–‡å¿ƒå¥åº· Â· è¯ç‰©å’¨è¯¢
        if (target.classList.contains('drug-consult-btn')) {
          var jsonText = window.__lastDrugJsonForConsult__ || '';
          var drugName = window.__lastDrugNameForConsult__ || '';

          if (!jsonText) {
            layer.msg('æš‚æœªè·å–åˆ°è¯å“ä¿¡æ¯', {icon: 0, time: 1500});
            return;
          }

          // 1ï¼‰å…³é—­å½“å‰çš„â€œè¯å“è¯¦æƒ…â€å¼¹æ¡†
          if (typeof window.__drugDetailLayerIndex__ === 'number') {
            layer.close(window.__drugDetailLayerIndex__);
            window.__drugDetailLayerIndex__ = null;
          }

          // 2ï¼‰æ‰“å¼€æ–‡å¿ƒåŠ©æ‰‹å³ä¾§å¼¹çª—
          var overlay = document.getElementById('assistant-modal-overlay');
          if (overlay) {
            overlay.style.display = 'flex';
          }

          // 3ï¼‰æ„é€ è¦å‘ç»™åŠ©æ‰‹çš„æ–‡æœ¬
          var messageText =
            'ä¸‹é¢æ˜¯è¯å“ã€' + drugName + 'ã€‘çš„è¯´æ˜ä¹¦å…³é”®ä¿¡æ¯ï¼Œè¯·ä½ ä»åŒ»ç”Ÿ/è¯å¸ˆè§†è§’ç»™å‡ºç”¨è¯é£é™©æç¤ºã€ç¦å¿Œå’Œæ³¨æ„äº‹é¡¹è¯´æ˜ï¼š\n\n'
            + jsonText;

          // 4ï¼‰é€šè¿‡ postMessage æŠŠæ–‡æœ¬å‘ç»™ iframeï¼ˆ/chat_embed é¡µé¢ï¼‰
          var iframe = document.querySelector('#assistant-modal iframe');
          if (iframe && iframe.contentWindow) {
            iframe.contentWindow.postMessage(
              {
                type: 'drug_consult',
                text: messageText
              },
              '*'
            );
          } else {
            // å¦‚æœ iframe æœªå‡†å¤‡å¥½ï¼Œç»™ä¸ªæç¤ºï¼ˆæˆ–è€…åšé‡è¯•é€»è¾‘ï¼‰
            layer.msg('æ–‡å¿ƒå¥åº·åŠ©æ‰‹å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•', {icon: 0, time: 1500});
          }
        }

      });
    });
  </script>
  

  <!-- å›å¡« query + æ–‡å¿ƒåŠ©æ‰‹å¼¹çª—æ§åˆ¶ -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // å›å¡«æœç´¢è¯
      var params = new URLSearchParams(window.location.search);
      var q = params.get('query');
      if (q) {
        var input = document.getElementById('search-input');
        if (input) input.value = q;
      }

      // æ–‡å¿ƒåŠ©æ‰‹å¼¹çª—
      var openBtn   = document.getElementById('assistant-open-btn');
      var overlay   = document.getElementById('assistant-modal-overlay');
      var modal     = document.getElementById('assistant-modal');
      var closeBtn  = document.getElementById('assistant-modal-close');
      var resizeBtn = document.getElementById('assistant-modal-resize');

      if (openBtn && overlay && closeBtn && modal && resizeBtn) {
        openBtn.addEventListener('click', function () {
          overlay.style.display = 'flex';
        });
        closeBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          overlay.style.display = 'none';
        });
        overlay.addEventListener('click', function (e) {
          if (e.target === overlay) overlay.style.display = 'none';
        });

        // normal -> large -> full -> normal
        resizeBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          var current = modal.getAttribute('data-size') || 'normal';
          var next = current === 'normal' ? 'large' : (current === 'large' ? 'full' : 'normal');
          modal.setAttribute('data-size', next);
          modal.classList.remove('assistant-modal-large', 'assistant-modal-full');
          if (next === 'large') modal.classList.add('assistant-modal-large');
          else if (next === 'full') modal.classList.add('assistant-modal-full');
        });
      }
    });
  </script>

</body>
</html>
